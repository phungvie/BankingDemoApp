BROKER SCHEMA transfer
PATH common; -- Giữ nguyên dòng này cũng được, sau này muốn dùng lại constants thì tiện

CREATE COMPUTE MODULE Validation
    CREATE FUNCTION Main() RETURNS BOOLEAN
    BEGIN
        SET OutputRoot = InputRoot;
        DECLARE refIn REFERENCE TO InputRoot.JSON.Data;
        
        DECLARE fromAcc CHARACTER refIn.fromAccount;
        DECLARE toAcc   CHARACTER refIn.toAccount;
        DECLARE amount  DECIMAL refIn.amount;

        -- =========================================================
        -- 1. KIỂM TRA TÀI KHOẢN NGUỒN
        -- =========================================================
        DECLARE dbStatusFrom CHARACTER;
        DECLARE dbBalanceFrom DECIMAL;
        
        SET Environment.Temp.AccSender[] = 
            SELECT T.STATUS, T.BALANCE 
            FROM Database.CBS.CBS_USER.ACCOUNTS AS T
            WHERE T.ACC_NO = fromAcc;

        -- Check tồn tại người gửi
        IF NOT EXISTS(Environment.Temp.AccSender[]) THEN
            -- Trước đây là common.C_ERR_ACC_NOT_FOUND
            CALL ThrowError('ACC_NOT_FOUND', 'Tài khoản nguồn không tồn tại.'); 
            RETURN FALSE;
        END IF;

        -- Check trạng thái người gửi
        -- Trước đây là so với common.C_ACC_ACTIVE
        IF Environment.Temp.AccSender[1].STATUS <> 'ACTIVE' THEN 
            CALL ThrowError('ACC_LOCKED', 'Tài khoản nguồn đang bị khóa.');
            RETURN FALSE;
        END IF;

        -- Check số dư
        IF Environment.Temp.AccSender[1].BALANCE < amount THEN
            -- Trước đây là common.C_ERR_INSUFFICIENT_FND
            CALL ThrowError('INSUFFICIENT_FUND', 'Số dư không đủ.');
            RETURN FALSE;
        END IF;

        -- =========================================================
        -- 2. KIỂM TRA TÀI KHOẢN ĐÍCH
        -- =========================================================
        DECLARE dbStatusTo CHARACTER;
        SET dbStatusTo = THE(SELECT ITEM T.STATUS 
                             FROM Database.CBS.CBS_USER.ACCOUNTS AS T
                             WHERE T.ACC_NO = toAcc);

        -- Check tồn tại người nhận
        IF dbStatusTo IS NULL THEN
            -- Trước đây là common.C_ERR_ACC_NOT_FOUND
            CALL ThrowError('ACC_NOT_FOUND', 'Tài khoản thụ hưởng không tồn tại.');
            RETURN FALSE;
        END IF;

        -- Check trạng thái người nhận
        -- Trước đây là so với common.C_ACC_ACTIVE
        IF dbStatusTo <> 'ACTIVE' THEN
            CALL ThrowError('ACC_LOCKED', 'Tài khoản thụ hưởng đang bị khóa.');
            RETURN FALSE;
        END IF;

        -- Nếu cả 2 đều OK -> Đi tiếp
        -- Trước đây: PROPAGATE TO TERMINAL common.C_TERM_OUT;
        PROPAGATE TO TERMINAL 'out';
        RETURN FALSE;
    END;

    -- Procedure con để throw lỗi
    CREATE PROCEDURE ThrowError(IN errCode CHARACTER, IN errMsg CHARACTER)
    BEGIN
        -- Trước đây: common.C_ERR_TYPE_BIZ
        SET Environment.Variables.ErrorType = 'BUSINESS';
        SET Environment.Variables.ErrorCode = errCode;
        SET Environment.Variables.ErrorMessage = errMsg;
        -- Trước đây: common.C_TERM_OUT_ERR
        PROPAGATE TO TERMINAL 'out1';
    END;
END MODULE;
